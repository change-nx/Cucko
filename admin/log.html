<style>
    /* 日志页面基础样式 */
    .logs-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        height: calc(100vh - 140px);
        max-height: 800px;
    }
    
    /* 日志列表部分 */
    .logs-list-section {
        background-color: var(--card-bg);
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 2px 8px var(--shadow-color);
        border: 1px solid var(--sidebar-border);
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
    }
    
    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 10px;
        flex-shrink: 0;
    }
    
    .section-title i {
        font-size: 18px;
    }
    
    /* 日志网格 */
    .logs-grid {
        display: grid;
        gap: 12px;
        overflow-y: auto;
        flex: 1;
        min-height: 0;
        padding-right: 4px;
    }
    
    .logs-grid::-webkit-scrollbar {
        width: 6px;
    }
    
    .logs-grid::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .logs-grid::-webkit-scrollbar-thumb {
        background: rgba(var(--primary-rgb), 0.3);
        border-radius: 3px;
    }
    
    .logs-grid::-webkit-scrollbar-thumb:hover {
        background: rgba(var(--primary-rgb), 0.5);
    }
    
    .log-card {
        background-color: rgba(var(--primary-rgb), 0.03);
        border-radius: 10px;
        padding: 16px;
        border: 1px solid var(--sidebar-border);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .log-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px var(--shadow-color);
        border-color: var(--primary-color);
    }
    
    .log-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .log-name {
        font-weight: 600;
        color: var(--primary-color);
        font-size: 15px;
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .log-date {
        font-size: 12px;
        color: var(--text-secondary);
    }
    
    .log-actions {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
    }
    
    .action-btn {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgba(var(--primary-rgb), 0.1);
        color: var(--primary-color);
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 16px;
    }
    
    .action-btn:hover {
        background-color: rgba(var(--primary-rgb), 0.2);
    }
    
    .action-btn.view {
        color: #4CAF50;
        background-color: rgba(76, 175, 80, 0.1);
    }
    
    .action-btn.view:hover {
        background-color: rgba(76, 175, 80, 0.2);
    }
    
    .action-btn.delete {
        color: #ff6b6b;
        background-color: rgba(255, 107, 107, 0.1);
    }
    
    .action-btn.delete:hover {
        background-color: rgba(255, 107, 107, 0.2);
    }
    
    /* 聊天界面样式 */
    .chat-container {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--content-bg);
        z-index: 2000;
        display: none;
        flex-direction: column;
    }
    
    .chat-container.active {
        display: flex;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }
    
    .chat-header {
        background: var(--card-bg);
        padding: 16px 20px;
        display: flex;
        align-items: center;
        gap: 12px;
        border-bottom: 1px solid var(--sidebar-border);
        box-shadow: 0 2px 8px var(--shadow-color);
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .back-btn {
        background: none;
        border: none;
        color: var(--primary-color);
        font-size: 18px;
        cursor: pointer;
        padding: 8px;
        width: 40px;
        height: 40px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }
    
    .back-btn:hover {
        background-color: rgba(var(--primary-rgb), 0.1);
    }
    
    .chat-info {
        flex: 1;
        min-width: 0;
    }
    
    .chat-name {
        font-weight: 600;
        font-size: 16px;
        color: var(--primary-color);
        margin-bottom: 2px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .chat-id {
        font-size: 13px;
        color: var(--text-secondary);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* 消息列表样式 */
    .messages-container {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: var(--content-bg);
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    
    .messages-container::-webkit-scrollbar {
        width: 6px;
    }
    
    .messages-container::-webkit-scrollbar-track {
        background: transparent;
    }
    
    .messages-container::-webkit-scrollbar-thumb {
        background: rgba(var(--primary-rgb), 0.3);
        border-radius: 3px;
    }
    
    .messages-container::-webkit-scrollbar-thumb:hover {
        background: rgba(var(--primary-rgb), 0.5);
    }
    
    /* 聊天消息样式 */
    .chat-message {
        max-width: 100%;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .message-bubble {
        background: var(--card-bg);
        border-radius: 18px;
        padding: 12px 16px;
        border: 1px solid var(--sidebar-border);
        word-wrap: break-word;
        word-break: break-all;
        overflow-wrap: break-word;
        max-width: 100%;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        box-shadow: 0 2px 4px var(--shadow-color);
    }
    
    .message-bubble:hover {
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px var(--shadow-color);
    }
    
    .message-bubble.copied {
        border-color: #4CAF50;
        background-color: rgba(76, 175, 80, 0.05);
    }
    
    .message-content {
        font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        font-size: 13px;
        line-height: 1.6;
        white-space: pre-wrap;
        color: var(--text-primary);
    }
    
    .message-time {
        font-size: 11px;
        color: var(--text-light);
        text-align: right;
        opacity: 0.7;
        margin-top: 4px;
    }
    
    /* 警告消息样式 */
    .warning-bubble {
        background: rgba(255, 152, 0, 0.08);
        border-radius: 18px;
        padding: 12px 16px;
        border: 1px solid rgba(255, 152, 0, 0.3);
        word-wrap: break-word;
        word-break: break-all;
        overflow-wrap: break-word;
        max-width: 100%;
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .warning-bubble:hover {
        border-color: #ff9800;
        box-shadow: 0 4px 12px rgba(255, 152, 0, 0.1);
    }
    
    .warning-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        color: #ff9800;
        font-weight: 500;
        font-size: 13px;
    }
    
    .warning-content {
        font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        font-size: 13px;
        line-height: 1.6;
        white-space: pre-wrap;
        color: var(--text-primary);
    }
    
    .copy-hint {
        position: absolute;
        top: -10px;
        right: 10px;
        background-color: var(--primary-color);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 11px;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 2;
    }
    
    .message-bubble:hover .copy-hint,
    .warning-bubble:hover .copy-hint {
        opacity: 1;
    }
    
    /* 加载状态 */
    .loading-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .loading-spinner {
        width: 36px;
        height: 36px;
        border: 3px solid var(--sidebar-border);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 12px;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .loading-text {
        font-size: 14px;
    }
    
    /* 空状态 */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-secondary);
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .empty-icon {
        font-size: 36px;
        color: var(--primary-light);
        margin-bottom: 12px;
    }
    
    .empty-text {
        font-size: 15px;
        margin-bottom: 8px;
    }
    
    .empty-subtext {
        font-size: 13px;
        color: var(--text-light);
    }
    
    /* 复制提示 */
    .copy-notification {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0.9);
        background-color: var(--primary-color);
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 1002;
        opacity: 0;
        transition: all 0.3s ease;
        pointer-events: none;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    }
    
    .copy-notification.show {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
    
    /* 响应式设计 */
    @media (max-width: 767px) {
        .logs-grid {
            grid-template-columns: 1fr;
        }
        
        .action-btn span {
            display: none;
        }
        
        .messages-container {
            padding: 16px;
        }
        
        .message-bubble, .warning-bubble {
            padding: 10px 14px;
        }
        
        .message-content, .warning-content {
            font-size: 12px;
        }
    }
    
    @media (min-width: 768px) {
        .logs-grid {
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }
        
        .action-btn span {
            display: none;
        }
    }
    
    @media (min-width: 1024px) {
        .logs-grid {
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        }
    }
</style>

<div class="logs-container">
    <!-- 日志列表部分 -->
    <div class="logs-list-section">
        <div class="section-title">
            <i class="fas fa-file-alt"></i>
            <span>日志文件</span>
        </div>
        
        <div class="logs-grid" id="logsGrid">
            <!-- 日志卡片将通过JS动态生成 -->
        </div>
        
        <!-- 加载状态 -->
        <div class="loading-state" id="logsLoading">
            <div class="loading-spinner"></div>
            <div class="loading-text">正在加载日志列表...</div>
        </div>
        
        <!-- 空状态 -->
        <div class="empty-state" id="logsEmpty" style="display: none;">
            <div class="empty-icon">
                <i class="fas fa-file"></i>
            </div>
            <div class="empty-text">暂无日志文件</div>
            <div class="empty-subtext">系统尚未生成任何日志文件</div>
            <button class="action-btn view" onclick="fetchLogsList()" style="margin-top: 12px;">
                <i class="fas fa-redo"></i>
            </button>
        </div>
    </div>
</div>

<!-- 聊天界面 -->
<div class="chat-container" id="chatContainer">
    <div class="chat-header">
        <button class="back-btn" onclick="closeLogDetail()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="chat-info">
            <div class="chat-name" id="chatName"></div>
            <div class="chat-id" id="chatId"></div>
        </div>
    </div>
    
    <div class="messages-container" id="messagesContainer">
        <!-- 日志内容将以消息气泡形式显示 -->
    </div>
</div>

<!-- 复制提示 -->
<div class="copy-notification" id="copyNotification">
    <i class="fas fa-check"></i> 已复制
</div>

<script>
    // 全局变量
    let allLogs = [];
    let currentLogFile = '';
    let currentLogContent = [];
    let isChatViewActive = false;
    
    // 页面加载时获取日志列表
    document.addEventListener('DOMContentLoaded', function() {
        fetchLogsList();
        setupMessageCopy();
    });
    
    // 设置消息复制功能
    function setupMessageCopy() {
        // 长按复制（移动端）
        document.addEventListener('touchstart', function(e) {
            const bubble = e.target.closest('.message-bubble, .warning-bubble');
            if (bubble) {
                bubble.startTime = Date.now();
                bubble.touchTimer = setTimeout(() => {
                    copyMessageContent(bubble);
                }, 800);
            }
        });
        
        document.addEventListener('touchend', function(e) {
            const bubble = e.target.closest('.message-bubble, .warning-bubble');
            if (bubble && bubble.touchTimer) {
                clearTimeout(bubble.touchTimer);
            }
        });
        
        document.addEventListener('touchmove', function(e) {
            const bubble = e.target.closest('.message-bubble, .warning-bubble');
            if (bubble && bubble.touchTimer) {
                clearTimeout(bubble.touchTimer);
            }
        });
        
        // 双击复制（桌面端）
        document.addEventListener('dblclick', function(e) {
            if (window.innerWidth >= 768) {
                const bubble = e.target.closest('.message-bubble, .warning-bubble');
                if (bubble) {
                    copyMessageContent(bubble);
                }
            }
        });
    }
    
    // 获取日志列表
    async function fetchLogsList() {
        showElement('logsLoading');
        hideElement('logsEmpty');
        
        try {
            const response = await fetch('../api.php?type=log&action=list');
            allLogs = await response.json();
            
            renderLogsGrid();
        } catch (error) {
            console.error('获取日志列表失败:', error);
            showToast('无法加载日志列表', 'error');
        } finally {
            hideElement('logsLoading');
        }
    }
    
    // 渲染日志网格
    function renderLogsGrid() {
        const logsGrid = document.getElementById('logsGrid');
        
        if (!allLogs || allLogs.length === 0) {
            showElement('logsEmpty');
            logsGrid.innerHTML = '';
            return;
        }
        
        hideElement('logsEmpty');
        
        // 按日期倒序排序
        const sortedLogs = [...allLogs].sort((a, b) => {
            const dateA = extractDateFromFilename(a);
            const dateB = extractDateFromFilename(b);
            return dateB - dateA; // 最新的在前
        });
        
        logsGrid.innerHTML = sortedLogs.map(logFile => {
            const dateStr = extractDateFromFilename(logFile);
            const formattedDate = formatDate(dateStr);
            
            return `
                <div class="log-card" onclick="viewLog('${logFile}')">
                    <div class="log-card-header">
                        <div style="flex: 1; min-width: 0;">
                            <div class="log-name" title="${logFile}">${logFile}</div>
                        </div>
                        <div class="log-actions">
                            <button class="action-btn view" onclick="viewLog('${logFile}'); event.stopPropagation();" title="查看">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteLogPrompt('${logFile}'); event.stopPropagation();" title="删除">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="log-date">${formattedDate}</div>
                </div>
            `;
        }).join('');
    }
    
    // 从文件名提取日期
    function extractDateFromFilename(filename) {
        const match = filename.match(/(\d{4}-\d{2}-\d{2})/);
        return match ? match[1] : 'Unknown';
    }
    
    // 格式化日期
    function formatDate(dateStr) {
        if (dateStr === 'Unknown') return '未知日期';
        
        try {
            const date = new Date(dateStr);
            const now = new Date();
            const diffTime = now - date;
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return '今天';
            if (diffDays === 1) return '昨天';
            if (diffDays < 7) return `${diffDays}天前`;
            
            return dateStr.replace(/-/g, '/');
        } catch (e) {
            return dateStr;
        }
    }
    
    // 查看日志内容（聊天界面形式）
    async function viewLog(logFile) {
        currentLogFile = logFile;
        
        // 显示聊天界面
        const chatContainer = document.getElementById('chatContainer');
        const chatName = document.getElementById('chatName');
        const chatId = document.getElementById('chatId');
        
        chatName.textContent = logFile;
        chatId.textContent = '日志文件';
        chatContainer.classList.add('active');
        isChatViewActive = true;
        
        // 显示加载状态
        const messagesContainer = document.getElementById('messagesContainer');
        messagesContainer.innerHTML = `
            <div class="loading-state">
                <div class="loading-spinner"></div>
                <div class="loading-text">正在加载日志内容...</div>
            </div>
        `;
        
        try {
            const response = await fetch(`../api.php?type=log&action=content&name=${encodeURIComponent(logFile)}`);
            const textContent = await response.text();
            
            if (!textContent || textContent.trim() === '') {
                messagesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-file-exclamation"></i>
                        </div>
                        <div class="empty-text">日志内容为空</div>
                        <div class="empty-subtext">该日志文件没有内容</div>
                    </div>
                `;
                return;
            }
            
            // 分割日志行
            const lines = textContent.split('\n').filter(line => line.trim() !== '');
            currentLogContent = lines.map((line, index) => {
                const item = {
                    original: line,
                    content: line,
                    isJson: false,
                    formatted: '',
                    timestamp: new Date(Date.now() - (lines.length - index) * 1000).getTime()
                };
                
                try {
                    const jsonObj = JSON.parse(line);
                    item.isJson = true;
                    item.formatted = JSON.stringify(jsonObj, null, 2);
                    item.content = item.formatted;
                } catch (e) {
                    // 不是JSON，保持原样
                    item.isJson = false;
                    item.formatted = line;
                    item.content = line;
                }
                
                return item;
            });
            
            // 渲染聊天消息
            renderChatMessages();
            
        } catch (error) {
            console.error('加载日志内容失败:', error);
            showToast('加载日志内容失败', 'error');
            
            messagesContainer.innerHTML = `
                <div class="chat-message">
                    <div class="warning-bubble">
                        <div class="warning-header">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>加载失败</span>
                        </div>
                        <div class="warning-content">无法加载日志内容，请检查网络连接</div>
                    </div>
                </div>
            `;
        }
    }
    
    // 渲染聊天消息
    function renderChatMessages() {
        const messagesContainer = document.getElementById('messagesContainer');
        
        if (!currentLogContent || currentLogContent.length === 0) {
            messagesContainer.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-file-exclamation"></i>
                    </div>
                    <div class="empty-text">日志内容为空</div>
                </div>
            `;
            return;
        }
        
        // 生成聊天消息
        const messagesHtml = currentLogContent.map((item, index) => {
            const escapedContent = escapeHtml(item.content);
            const timestamp = new Date(item.timestamp).toLocaleTimeString();
            
            if (item.isJson) {
                return `
                    <div class="chat-message">
                        <div class="message-bubble" data-index="${index}">
                            <div class="copy-hint">长按或双击复制</div>
                            <div class="message-content">${escapedContent}</div>
                            <div class="message-time">${timestamp}</div>
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="chat-message">
                        <div class="warning-bubble" data-index="${index}">
                            <div class="copy-hint">长按或双击复制</div>
                            <div class="warning-header">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>非JSON格式数据</span>
                            </div>
                            <div class="warning-content">${escapedContent}</div>
                            <div class="message-time">${timestamp}</div>
                        </div>
                    </div>
                `;
            }
        }).join('');
        
        messagesContainer.innerHTML = messagesHtml;
        
        // 滚动到底部
        setTimeout(() => {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }, 100);
    }
    
    // 复制消息内容
    function copyMessageContent(bubble) {
        const contentElement = bubble.querySelector('.message-content, .warning-content');
        if (!contentElement) return;
        
        const textToCopy = contentElement.textContent || contentElement.innerText;
        
        navigator.clipboard.writeText(textToCopy)
            .then(() => {
                // 显示复制成功效果
                bubble.classList.add('copied');
                showCopyNotification();
                
                setTimeout(() => {
                    bubble.classList.remove('copied');
                }, 1000);
            })
            .catch(err => {
                console.error('复制失败:', err);
                showToast('复制失败', 'error');
            });
    }
    
    // 显示复制提示
    function showCopyNotification() {
        const notification = document.getElementById('copyNotification');
        notification.classList.add('show');
        
        setTimeout(() => {
            notification.classList.remove('show');
        }, 1500);
    }
    
    // 关闭日志详情（聊天界面）
    function closeLogDetail() {
        const chatContainer = document.getElementById('chatContainer');
        chatContainer.classList.remove('active');
        isChatViewActive = false;
        currentLogFile = '';
        currentLogContent = [];
    }
    
    // 删除日志提示
    function deleteLogPrompt(logFile) {
        if (confirm(`确定要删除日志文件 "${logFile}" 吗？此操作不可恢复。`)) {
            deleteLog(logFile);
        }
    }
    
    // 删除日志
    async function deleteLog(logFile) {
        try {
            const response = await fetch(`../api.php?type=log&action=del&name=${encodeURIComponent(logFile)}`);
            const result = await response.json();
            
            if (result === true) {
                showToast(`已删除日志文件`, 'success');
                
                // 从列表中移除
                allLogs = allLogs.filter(file => file !== logFile);
                
                // 重新渲染网格
                renderLogsGrid();
                
                // 如果正在查看这个日志，关闭查看窗口
                if (currentLogFile === logFile) {
                    closeLogDetail();
                }
            } else {
                showToast('删除失败', 'error');
            }
            
        } catch (error) {
            console.error('删除日志失败:', error);
            showToast('删除失败', 'error');
        }
    }
    
    // HTML转义
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // 显示元素
    function showElement(elementId) {
        const element = document.getElementById(elementId);
        if (element) element.style.display = 'block';
    }
    
    // 隐藏元素
    function hideElement(elementId) {
        const element = document.getElementById(elementId);
        if (element) element.style.display = 'none';
    }
    
    // 显示Toast消息
    function showToast(message, type = 'info') {
        // 创建Toast元素
        const toast = document.createElement('div');
        toast.className = 'copy-notification';
        toast.textContent = message;
        toast.id = 'tempToast';
        
        // 设置颜色
        if (type === 'success') {
            toast.style.backgroundColor = '#4CAF50';
        } else if (type === 'error') {
            toast.style.backgroundColor = '#ff6b6b';
        } else if (type === 'warning') {
            toast.style.backgroundColor = '#ff9800';
        } else {
            toast.style.backgroundColor = 'var(--primary-color)';
        }
        
        // 添加到页面
        document.body.appendChild(toast);
        
        // 显示动画
        setTimeout(() => {
            toast.classList.add('show');
        }, 10);
        
        // 2秒后移除
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 300);
        }, 2000);
    }
</script>